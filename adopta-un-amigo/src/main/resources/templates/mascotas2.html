<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mascotas</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex align-items-center">
                <img src="/images/garrita.png" alt="Garritas de Perrito" width="50" height="50" class="mr-3">
                <h1 class="mt-5">Peluditos en Adopción</h1>
            </div>
            <a href="/" class="btn btn-primary">Volver al Home</a>
        </div>
        <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Ver Mascotas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="buscar-id-tab" data-toggle="tab" href="#buscar-id" role="tab" aria-controls="buscar-id" aria-selected="false">Buscar por ID</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="buscar-nombre-tab" data-toggle="tab" href="#buscar-nombre" role="tab" aria-controls="buscar-nombre" aria-selected="false">Buscar por Nombre</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="agregar-tab" data-toggle="tab" href="#agregar" role="tab" aria-controls="agregar" aria-selected="false">Agregar Mascota</a>
            </li>
        </ul>
        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div id="mascotas"></div>
                <nav>
                    <ul class="pagination" id="pagination"></ul>
                </nav>
            </div>
            <div class="tab-pane fade" id="buscar-id" role="tabpanel" aria-labelledby="buscar-id-tab">
                <form id="buscarIdForm">
                    <div class="form-group">
                        <label for="id">ID:</label>
                        <input type="number" class="form-control" id="id" name="id" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </form>
                <div id="resultadoId" class="mt-3"></div>
            </div>
            <div class="tab-pane fade" id="buscar-nombre" role="tabpanel" aria-labelledby="buscar-nombre-tab">
                <form id="buscarNombreForm">
                    <div class="form-group">
                        <label for="nombre-buscar">Nombre:</label>
                        <input type="text" class="form-control" id="nombre-buscar" name="nombre" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </form>
                <div id="resultadoNombre" class="mt-3"></div>
            </div>
            <div class="tab-pane fade" id="agregar" role="tabpanel" aria-labelledby="agregar-tab">
                <h2 class="mt-5">Agregar Nueva Mascota</h2>
                <form id="mascotaForm">
                    <div class="form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="raza">Raza:</label>
                        <input type="text" class="form-control" id="raza" name="raza" required>
                    </div>
                    <div class="form-group">
                        <label for="peso">Peso:</label>
                        <input type="number" class="form-control" id="peso" name="peso" required>
                    </div>
                    <div class="form-group">
                        <label for="chip">¿Tiene chip?</label>
                        <select class="form-control" id="chip" name="chip" required>
                            <option value="true">Sí</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha de Nacimiento:</label>
                        <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label for="sexo">Sexo:</label>
                        <select class="form-control" id="sexo" name="sexo" required>
                            <option value="Macho">Macho</option>
                            <option value="Hembra">Hembra</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Variables de estado
            let currentPage = 0;

            // Función para cargar la lista de mascotas paginadas
            function loadMascotas(page) {
            	if (isNaN(page) || page < 0) {
                    page = 0;
                }
                $.ajax({
                    url: `/api/mascotas/page?page=${page}`,
                    type: 'GET',
                    success: function(data) {
                        const mascotas = data.content;
                        const totalPages = data.totalPages;

                        let html = '<table class="table table-striped">';
                        html += '<thead><tr><th>ID</th><th>Nombre</th><th>Raza</th><th>Peso</th><th>¿Tiene chip?</th><th>Fecha de Nacimiento</th><th>Sexo</th><th>Acciones</th></tr></thead><tbody>';
                        mascotas.forEach(function(mascota) {
                            html += `<tr>
                                <td>${mascota.id}</td>
                                <td>${mascota.nombre}</td>
                                <td>${mascota.raza}</td>
                                <td>${mascota.peso}</td>
                                <td>${mascota.tieneChip ? 'Sí' : 'No'}</td>
                                <td>${mascota.fechaNac}</td>
                                <td>${mascota.sexo}</td>
                                <td><button class="btn btn-danger btn-sm eliminar-mascota" data-id="${mascota.id}">Eliminar</button></td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                        $('#mascotas').html(html);

                        // Crear botones de paginación
                        let paginationHtml = '';
                        for (let i = 0; i < totalPages; i++) {
                            paginationHtml += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#">${i + 1}</a></li>`;
                        }
                        $('#pagination').html(paginationHtml);

                        // Agregar manejador de eventos a los botones de paginación
                        $('.page-link').on('click', function(event) {
                            event.preventDefault();
                            const newPage = $(this).text() - 1;
                            currentPage = newPage;
                            loadMascotas(currentPage);
                        });
                    },
                    error: function(err) {
                        console.error('Error obteniendo las mascotas', err);
                    }
                });
            }

            // Llamar a la función para cargar las mascotas al cargar la página
            loadMascotas(currentPage);
            
            // Manejar el envío del formulario para agregar una nueva mascota
            $('#mascotaForm').on('submit', function(event) {
                event.preventDefault();

                const mascotaData = {
                    nombre: $('#nombre').val(),
                    raza: $('#raza').val(),
                    peso: $('#peso').val(),
                    tieneChip: $('#chip').val() === 'true',
                    fechaNac: $('#fechaNacimiento').val(),
                    sexo: $('#sexo').val()
                };

                $.ajax({
                    url: '/api/mascotas',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(mascotaData),
                    success: function(response) {
                        alert('Mascota agregada exitosamente!');
                        $('#mascotaForm')[0].reset();
                        loadMascotas();
                    },
                    error: function(err) {
                        console.error('Error agregando la mascota', err);
                    }
                });
            });

            // Manejar el envío del formulario para buscar mascota por ID
            $('#buscarIdForm').on('submit', function(event) {
                event.preventDefault();

                const id = $('#id').val();

                $.ajax({
                    url: `/api/mascotas/${id}`,
                    type: 'GET',
                    success: function(data) {
                        let html = '<table class="table table-striped">';
                        html += '<thead><tr><th>ID</th><th>Nombre</th><th>Raza</th><th>Peso</th><th>¿Tiene chip?</th><th>Fecha de Nacimiento</th><th>Sexo</th></tr></thead><tbody>';
                        html += `<tr><td>${data.id}</td><td>${data.nombre}</td><td>${data.raza}</td><td>${data.peso}</td><td>${data.tieneChip ? 'Sí' : 'No'}</td><td>${data.fechaNac}</td><td>${data.sexo}</td></tr>`;
                        html += '</tbody></table>';
                        $('#resultadoId').html(html);
                    },
                    error: function(err) {
                        console.error('Error buscando la mascota por ID', err);
                        $('#resultadoId').html('<div class="alert alert-danger">Mascota no encontrada</div>');
                    }
                });
            });

            // Manejar el envío del formulario para buscar mascota por nombre
            $('#buscarNombreForm').on('submit', function(event) {
                event.preventDefault();

                const nombre = $('#nombre-buscar').val();

                $.ajax({
                    url: `/api/mascotas/nombre/${nombre}`,
                    type: 'GET',
                    success: function(data) {
                        let html = '<table class="table table-striped">';
                        html += '<thead><tr><th>ID</th><th>Nombre</th><th>Raza</th><th>Peso</th><th>¿Tiene chip?</th><th>Fecha de Nacimiento</th><th>Sexo</th></tr></thead><tbody>';
                        data.forEach(function(mascota) {
                            html += `<tr><td>${mascota.id}</td><td>${mascota.nombre}</td><td>${mascota.raza}</td><td>${mascota.peso}</td><td>${mascota.tieneChip ? 'Sí' : 'No'}</td><td>${mascota.fechaNac}</td><td>${mascota.sexo}</td></tr>`;
                        });
                        html += '</tbody></table>';
                        $('#resultadoNombre').html(html);
                    },
                    error: function(err) {
                        console.error('Error buscando la mascota por nombre', err);
                        $('#resultadoNombre').html('<div class="alert alert-danger">Mascota no encontrada</div>');
                    }
                });
            });
       
            // Manejar la eliminación de una mascota
            $(document).on('click', '.eliminar-mascota', function() {
                const id = $(this).data('id');

                if (confirm('¿Estás seguro de que quieres eliminar esta mascota?')) {
                    $.ajax({
                        url: `/api/mascotas/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            alert('Mascota eliminada exitosamente!');
                            loadMascotas();
                        },
                        error: function(err) {
                            console.error('Error eliminando la mascota', err);
                        }
                    });
                }
            });
        
        
        });
    </script>
</body>
</html>
